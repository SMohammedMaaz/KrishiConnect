{% extends 'base.html' %}

{% block title %}Buyer Login - KrishiConnect{% endblock %}

{% block extra_css %}
<style>
    .container {
        min-height: 85vh;
        padding-top: 2rem;
        padding-bottom: 2rem;
    }
    .buyer-login-img {
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .buyer-login-img img {
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        max-height: 400px;
        object-fit: cover;
    }
    .features-list {
        background-color: rgba(255, 255, 255, 0.95);
        border-radius: 10px;
        padding: 20px;
        margin-top: -50px;
        position: relative;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
    }
    .features-list ul li {
        display: flex;
        align-items: flex-start;
        margin-bottom: 15px;
    }
    .features-list ul li i {
        margin-right: 10px;
        color: var(--primary-color);
        padding-top: 5px;
    }
    .login-container {
        max-width: 450px;
        margin: 0 auto;
        padding: 30px;
        border-radius: 12px;
        background-color: white;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
    }
    .auth-logo {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        font-weight: 700;
        font-size: 1.3rem;
    }
    .login-footer {
        text-align: center;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #eee;
    }
    .divider {
        display: flex;
        align-items: center;
        margin: 20px 0;
    }
    .divider-line {
        flex-grow: 1;
        height: 1px;
        background-color: #e2e8f0;
    }
    .divider-text {
        padding: 0 10px;
        color: #718096;
    }
    .social-login-btn {
        width: 100%;
        margin-bottom: 10px;
        padding: 10px 15px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 500;
        transition: all 0.3s;
        border: 1px solid #ddd;
        background-color: white;
    }
    .social-login-btn:hover {
        background-color: #f8f9fa;
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    }
    .social-login-btn img {
        width: 20px;
        margin-right: 10px;
    }
    .password-toggle {
        position: absolute;
        right: 10px;
        top: 10px;
        cursor: pointer;
        color: #6c757d;
    }
    .auth-link {
        color: var(--primary-color);
        text-decoration: none;
        font-weight: 500;
    }
    .auth-link:hover {
        text-decoration: underline;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-lg-6" data-aos="fade-right">
            <div class="auth-header d-lg-none">
                <div class="auth-logo">
                    <i data-feather="leaf" class="text-success me-2"></i>
                    <span>KrishiConnect</span>
                </div>
                <h3>Buyer Login</h3>
                <p class="text-muted">Access your buyer account</p>
            </div>
            
            <div class="login-container">
                <div class="auth-header d-none d-lg-block">
                    <div class="auth-logo">
                        <i data-feather="leaf" class="text-success me-2"></i>
                        <span>KrishiConnect</span>
                    </div>
                    <h3>Buyer Login</h3>
                    <p class="text-muted">Access direct purchasing from farmers</p>
                </div>
                
                <form id="login-form">
                    <div class="mb-4">
                        <label for="email" class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="email" placeholder="Enter your email" required>
                    </div>
                    
                    <div class="mb-4">
                        <label for="password" class="form-label">Password</label>
                        <div class="position-relative">
                            <input type="password" class="form-control" id="password" placeholder="Enter your password" required>
                            <span class="password-toggle" id="password-toggle">
                                <i data-feather="eye" id="show-password"></i>
                                <i data-feather="eye-off" id="hide-password" style="display: none;"></i>
                            </span>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mb-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="remember-me">
                            <label class="form-check-label" for="remember-me">
                                Remember me
                            </label>
                        </div>
                        <a href="#" class="auth-link">Forgot Password?</a>
                    </div>
                    
                    <div class="d-grid mb-3">
                        <button type="submit" class="btn btn-success" id="login-btn">
                            <span id="login-spinner" class="spinner-border spinner-border-sm me-2 d-none" role="status"></span>
                            Log In
                        </button>
                    </div>
                    
                    <div class="divider">
                        <div class="divider-line"></div>
                        <div class="divider-text">or continue with</div>
                        <div class="divider-line"></div>
                    </div>
                    
                    <div class="social-login">
                        <button type="button" class="social-login-btn" id="google-login">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" alt="Google">
                            Sign in with Google
                        </button>
                    </div>
                    
                    <div class="login-footer">
                        <p>New to KrishiConnect? <a href="/api/buyers/register-view/" class="auth-link">Create an account</a></p>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="col-lg-6 d-none d-lg-block" data-aos="fade-left">
            <div class="buyer-login-img">
                <img src="https://images.unsplash.com/photo-1505816014357-96b5ff457e9a?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1974&q=80" class="img-fluid" alt="Buyer Login">
                
                <div class="features-list mt-4">
                    <h4>Benefits for Buyers</h4>
                    <ul class="list-unstyled">
                        <li>
                            <i data-feather="check-circle"></i> 
                            <div>
                                <strong>Fresh Produce Direct from Farmers</strong>
                                <p class="text-muted mb-0">Get the freshest products with full traceability</p>
                            </div>
                        </li>
                        <li>
                            <i data-feather="check-circle"></i>
                            <div>
                                <strong>Location-Based Search</strong> 
                                <p class="text-muted mb-0">Find farmers and products near you</p>
                            </div>
                        </li>
                        <li>
                            <i data-feather="check-circle"></i>
                            <div>
                                <strong>Quality Verified Products</strong>
                                <p class="text-muted mb-0">Shop with confidence from verified farmers</p>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Firebase
        firebase.initializeApp(window.firebaseConfig);
        
        const auth = firebase.auth();
        
        // Password visibility toggle
        const passwordField = document.getElementById('password');
        const passwordToggle = document.getElementById('password-toggle');
        const showPasswordIcon = document.getElementById('show-password');
        const hidePasswordIcon = document.getElementById('hide-password');
        
        passwordToggle.addEventListener('click', function() {
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                showPasswordIcon.style.display = 'none';
                hidePasswordIcon.style.display = 'block';
            } else {
                passwordField.type = 'password';
                showPasswordIcon.style.display = 'block';
                hidePasswordIcon.style.display = 'none';
            }
        });
        
        // Login form submission
        const loginForm = document.getElementById('login-form');
        const loginBtn = document.getElementById('login-btn');
        const loginSpinner = document.getElementById('login-spinner');
        
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Show loading state
            loginBtn.disabled = true;
            loginSpinner.classList.remove('d-none');
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('remember-me').checked;
            
            // Set persistence
            const persistence = rememberMe ? firebase.auth.Auth.Persistence.LOCAL : firebase.auth.Auth.Persistence.SESSION;
            
            auth.setPersistence(persistence)
                .then(() => {
                    // Sign in with email and password
                    return auth.signInWithEmailAndPassword(email, password);
                })
                .then(userCredential => {
                    // Get ID token
                    return userCredential.user.getIdToken();
                })
                .then(token => {
                    // Send token to backend
                    return fetch('/api/buyers/login/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + token
                        },
                        body: JSON.stringify({ email: email })
                    });
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Login failed');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Redirect to dashboard
                        window.location.href = '/api/buyers/dashboard/';
                    } else {
                        throw new Error(data.message || 'Login failed');
                    }
                })
                .catch(error => {
                    console.error('Login error:', error);
                    let errorMessage = 'Failed to log in. Please check your credentials.';
                    
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                        errorMessage = 'Invalid email or password. Please try again.';
                    } else if (error.code === 'auth/too-many-requests') {
                        errorMessage = 'Too many failed login attempts. Please try again later.';
                    }
                    
                    alert(errorMessage);
                    
                    // Hide loading state
                    loginBtn.disabled = false;
                    loginSpinner.classList.add('d-none');
                });
        });
        
        // Google sign-in
        const googleLoginBtn = document.getElementById('google-login');
        
        googleLoginBtn.addEventListener('click', function() {
            const provider = new firebase.auth.GoogleAuthProvider();
            
            auth.signInWithPopup(provider)
                .then(result => {
                    // Get ID token
                    return result.user.getIdToken();
                })
                .then(token => {
                    // Send token to backend
                    return fetch('/api/buyers/login/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + token
                        },
                        body: JSON.stringify({
                            email: auth.currentUser.email,
                            is_google_login: true
                        })
                    });
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Login failed');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Check if new user
                        if (data.is_new_user) {
                            // Redirect to registration
                            window.location.href = '/api/buyers/register-view/';
                        } else {
                            // Redirect to dashboard
                            window.location.href = '/api/buyers/dashboard/';
                        }
                    } else {
                        throw new Error(data.message || 'Login failed');
                    }
                })
                .catch(error => {
                    console.error('Google login error:', error);
                    alert('Failed to log in with Google. Please try again.');
                });
        });
    });
</script>
{% endblock %}