{% extends 'base.html' %}

{% block title %}Browse Products - KrishiConnect{% endblock %}

{% block extra_css %}
<style>
    .filters-card {
        position: sticky;
        top: 20px;
    }
    .product-card {
        transition: transform 0.3s;
        height: 100%;
    }
    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    .price-range-container {
        padding: 0 10px;
    }
    .price-inputs {
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
    }
    .price-inputs input {
        width: 45%;
    }
    .map-container {
        height: 300px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .farmer-info {
        display: flex;
        align-items: center;
    }
    .farmer-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 10px;
    }
    .product-image {
        height: 200px;
        object-fit: cover;
    }
    #loading-products {
        min-height: 300px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .product-price {
        font-size: 1.25rem;
        font-weight: 600;
        color: #28a745;
    }
    .category-badge {
        background-color: #e9f7ef;
        color: #28a745;
        font-weight: 500;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i data-feather="shopping-bag"></i> Browse Products</h2>
    <div>
        <a href="/api/buyers/dashboard/" class="btn btn-outline-secondary">
            <i data-feather="arrow-left"></i> Back to Dashboard
        </a>
    </div>
</div>

<div class="row">
    <!-- Filters Sidebar -->
    <div class="col-md-3">
        <div class="card filters-card">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i data-feather="filter"></i> Filters</h5>
            </div>
            <div class="card-body">
                <form id="filter-form">
                    <!-- Search -->
                    <div class="mb-3">
                        <label for="search-query" class="form-label">Search Products</label>
                        <input type="text" class="form-control" id="search-query" placeholder="e.g., Rice, Wheat">
                    </div>
                    
                    <!-- Category -->
                    <div class="mb-3">
                        <label for="category-filter" class="form-label">Category</label>
                        <select class="form-select" id="category-filter">
                            <option value="">All Categories</option>
                            <option value="Grains">Grains</option>
                            <option value="Pulses">Pulses</option>
                            <option value="Fruits">Fruits</option>
                            <option value="Vegetables">Vegetables</option>
                            <option value="Spices">Spices</option>
                            <option value="Oils">Oils</option>
                            <option value="Dairy">Dairy</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <!-- Price Range -->
                    <div class="mb-3">
                        <label class="form-label">Price Range (â‚¹)</label>
                        <div class="price-range-container">
                            <div class="price-inputs">
                                <input type="number" class="form-control" id="min-price" placeholder="Min">
                                <input type="number" class="form-control" id="max-price" placeholder="Max">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Location -->
                    <div class="mb-3">
                        <label for="district-filter" class="form-label">District</label>
                        <select class="form-select" id="district-filter">
                            <option value="">All Districts</option>
                            <!-- Will be populated dynamically -->
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="state-filter" class="form-label">State</label>
                        <select class="form-select" id="state-filter">
                            <option value="">All States</option>
                            <option value="Andhra Pradesh">Andhra Pradesh</option>
                            <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                            <option value="Assam">Assam</option>
                            <option value="Bihar">Bihar</option>
                            <option value="Chhattisgarh">Chhattisgarh</option>
                            <option value="Goa">Goa</option>
                            <option value="Gujarat">Gujarat</option>
                            <option value="Haryana">Haryana</option>
                            <option value="Himachal Pradesh">Himachal Pradesh</option>
                            <option value="Jharkhand">Jharkhand</option>
                            <option value="Karnataka">Karnataka</option>
                            <option value="Kerala">Kerala</option>
                            <option value="Madhya Pradesh">Madhya Pradesh</option>
                            <option value="Maharashtra">Maharashtra</option>
                            <option value="Manipur">Manipur</option>
                            <option value="Meghalaya">Meghalaya</option>
                            <option value="Mizoram">Mizoram</option>
                            <option value="Nagaland">Nagaland</option>
                            <option value="Odisha">Odisha</option>
                            <option value="Punjab">Punjab</option>
                            <option value="Rajasthan">Rajasthan</option>
                            <option value="Sikkim">Sikkim</option>
                            <option value="Tamil Nadu">Tamil Nadu</option>
                            <option value="Telangana">Telangana</option>
                            <option value="Tripura">Tripura</option>
                            <option value="Uttar Pradesh">Uttar Pradesh</option>
                            <option value="Uttarakhand">Uttarakhand</option>
                            <option value="West Bengal">West Bengal</option>
                        </select>
                    </div>
                    
                    <!-- Nearby Only -->
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="nearby-only">
                            <label class="form-check-label" for="nearby-only">Show nearby only</label>
                        </div>
                        <small class="text-muted">Uses your current location</small>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success">
                            <i data-feather="search"></i> Apply Filters
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="reset-filters">
                            <i data-feather="x"></i> Reset Filters
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Products Grid -->
    <div class="col-md-9">
        <!-- Map View (optional, shown when nearby filter is active) -->
        <div class="card mb-4 d-none" id="map-view-card">
            <div class="card-body">
                <h5 class="mb-3">Products Near You</h5>
                <div id="map" class="map-container"></div>
                <div class="alert alert-info">
                    <i data-feather="info"></i> 
                    Products within ~50km of your location are shown on the map.
                </div>
            </div>
        </div>
        
        <!-- Results Summary -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span id="results-count">0</span> products found
                    </div>
                    <div class="d-flex align-items-center">
                        <label for="sort-by" class="me-2">Sort by:</label>
                        <select class="form-select form-select-sm" id="sort-by" style="width: auto;">
                            <option value="newest">Newest First</option>
                            <option value="price_low">Price: Low to High</option>
                            <option value="price_high">Price: High to Low</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Loading Indicator -->
        <div id="loading-products" class="text-center">
            <div>
                <div class="spinner-border text-success mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>Loading products...</p>
            </div>
        </div>
        
        <!-- Products Grid -->
        <div class="row" id="products-container"></div>
        
        <!-- No Results Message -->
        <div class="card d-none" id="no-results">
            <div class="card-body text-center py-5">
                <i data-feather="search" style="width: 48px; height: 48px;"></i>
                <h3 class="mt-3">No Products Found</h3>
                <p class="text-muted">Try adjusting your filters to see more results.</p>
                <button class="btn btn-outline-success" id="clear-filters-btn">
                    Clear All Filters
                </button>
            </div>
        </div>
        
        <!-- Pagination -->
        <nav aria-label="Product pagination" class="mt-4 d-none" id="pagination-container">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- Pagination will be added dynamically -->
            </ul>
        </nav>
    </div>
</div>

<!-- Product Detail Modal -->
<div class="modal fade" id="productDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-product-title">Product Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <img id="modal-product-image" src="" alt="Product Image" class="img-fluid rounded">
                        
                        <div class="row mt-2" id="modal-additional-images">
                            <!-- Additional images will be loaded here -->
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h4 id="modal-product-name"></h4>
                        <span class="badge bg-light text-dark category-badge mb-2" id="modal-product-category"></span>
                        
                        <p class="product-price" id="modal-product-price"></p>
                        
                        <div class="mb-3">
                            <h6>Available Quantity:</h6>
                            <p id="modal-product-quantity"></p>
                        </div>
                        
                        <div class="mb-3">
                            <h6>Quality Grade:</h6>
                            <p id="modal-product-quality"></p>
                        </div>
                        
                        <div class="mb-3">
                            <h6>Description:</h6>
                            <p id="modal-product-description"></p>
                        </div>
                        
                        <div class="mb-3">
                            <h6>Location:</h6>
                            <p id="modal-product-location"></p>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-body">
                                <h6 class="card-title">Farmer Details</h6>
                                <div class="d-flex align-items-center">
                                    <div class="farmer-avatar">
                                        <i data-feather="user" class="feather-small"></i>
                                    </div>
                                    <div>
                                        <p class="mb-0" id="modal-farmer-name"></p>
                                        <small class="text-muted" id="modal-farmer-location"></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button class="btn btn-success" id="modal-contact-farmer">
                                <i data-feather="phone"></i> Contact Farmer
                            </button>
                            <button class="btn btn-outline-success" id="modal-show-on-map">
                                <i data-feather="map-pin"></i> Show on Map
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Contact Farmer Modal -->
<div class="modal fade" id="contactFarmerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Contact Farmer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i data-feather="info"></i> 
                    This is a placeholder for the contact functionality. In the full implementation, 
                    this would connect you directly with the farmer.
                </div>
                
                <div class="mb-3">
                    <h6>Farmer:</h6>
                    <p id="contact-farmer-name">Farmer Name</p>
                </div>
                
                <div class="mb-3">
                    <h6>Product:</h6>
                    <p id="contact-product-name">Product Name</p>
                </div>
                
                <form id="contact-form">
                    <div class="mb-3">
                        <label for="contact-message" class="form-label">Message</label>
                        <textarea class="form-control" id="contact-message" rows="3" placeholder="I am interested in your product..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="contact-quantity" class="form-label">Quantity Interested In</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="contact-quantity" min="1">
                            <span class="input-group-text" id="contact-unit">kg</span>
                        </div>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="request-price-negotiation">
                        <label class="form-check-label" for="request-price-negotiation">
                            I would like to negotiate the price
                        </label>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-success">Send Message</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Firebase App (the core Firebase SDK) -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<!-- Firebase Auth -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<!-- Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places" defer></script>

<script src="/static/js/firebase-auth.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        let map = null;
        let markers = [];
        let currentLocation = null;
        let allProducts = [];
        let filteredProducts = [];
        
        // Get URL parameters for initial filter
        const urlParams = new URLSearchParams(window.location.search);
        const initialQuery = urlParams.get('query') || '';
        const initialCategory = urlParams.get('category') || '';
        const initialDistrict = urlParams.get('district') || '';
        const initialState = urlParams.get('state') || '';
        const initialNearby = urlParams.get('nearby') === 'true';
        
        // Set initial form values from URL parameters
        document.getElementById('search-query').value = initialQuery;
        document.getElementById('category-filter').value = initialCategory;
        document.getElementById('district-filter').value = initialDistrict;
        document.getElementById('state-filter').value = initialState;
        document.getElementById('nearby-only').checked = initialNearby;
        
        // Load products
        loadProducts();
        
        // Initialize map if nearby filter is active
        if (initialNearby) {
            document.getElementById('map-view-card').classList.remove('d-none');
            getUserLocation()
                .then(location => {
                    currentLocation = location;
                    initMap(location.latitude, location.longitude);
                })
                .catch(error => {
                    console.error('Error getting location:', error);
                    // Use default location for India
                    initMap(20.5937, 78.9629);
                });
        }
        
        // Filter form submit
        document.getElementById('filter-form').addEventListener('submit', function(e) {
            e.preventDefault();
            applyFilters();
        });
        
        // Reset filters
        document.getElementById('reset-filters').addEventListener('click', function() {
            document.getElementById('filter-form').reset();
            applyFilters();
        });
        
        document.getElementById('clear-filters-btn').addEventListener('click', function() {
            document.getElementById('filter-form').reset();
            applyFilters();
        });
        
        // Sort by change
        document.getElementById('sort-by').addEventListener('change', function() {
            sortProducts();
            displayProducts();
        });
        
        // Nearby only toggle
        document.getElementById('nearby-only').addEventListener('change', function() {
            const mapCard = document.getElementById('map-view-card');
            
            if (this.checked) {
                mapCard.classList.remove('d-none');
                getUserLocation()
                    .then(location => {
                        currentLocation = location;
                        initMap(location.latitude, location.longitude);
                        applyFilters();
                    })
                    .catch(error => {
                        console.error('Error getting location:', error);
                        this.checked = false;
                        mapCard.classList.add('d-none');
                        alert('Could not access your location. Please allow location access and try again.');
                    });
            } else {
                mapCard.classList.add('d-none');
                applyFilters();
            }
        });
        
        // Load products
        function loadProducts() {
            fetch('/api/products/list/?limit=100')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch products');
                    }
                    return response.json();
                })
                .then(products => {
                    // Hide loading indicator
                    document.getElementById('loading-products').classList.add('d-none');
                    
                    // Save all products
                    allProducts = products;
                    
                    // Populate district dropdown
                    populateDistrictDropdown(products);
                    
                    // Apply initial filters
                    applyFilters();
                })
                .catch(error => {
                    console.error('Error loading products:', error);
                    document.getElementById('loading-products').classList.add('d-none');
                    document.getElementById('products-container').innerHTML = `
                        <div class="alert alert-danger w-100">
                            Failed to load products. Please try again later.
                        </div>
                    `;
                });
        }
        
        // Apply filters
        function applyFilters() {
            const query = document.getElementById('search-query').value.toLowerCase();
            const category = document.getElementById('category-filter').value;
            const minPrice = document.getElementById('min-price').value ? parseFloat(document.getElementById('min-price').value) : null;
            const maxPrice = document.getElementById('max-price').value ? parseFloat(document.getElementById('max-price').value) : null;
            const district = document.getElementById('district-filter').value;
            const state = document.getElementById('state-filter').value;
            const nearbyOnly = document.getElementById('nearby-only').checked;
            
            // Filter products
            filteredProducts = allProducts.filter(product => {
                // Text search
                if (query && !(
                    product.name.toLowerCase().includes(query) || 
                    product.description.toLowerCase().includes(query)
                )) {
                    return false;
                }
                
                // Category
                if (category && product.category !== category) {
                    return false;
                }
                
                // Price range
                if (minPrice !== null && product.price < minPrice) {
                    return false;
                }
                
                if (maxPrice !== null && product.price > maxPrice) {
                    return false;
                }
                
                // Location
                if (district && (!product.address || product.address.district !== district)) {
                    return false;
                }
                
                if (state && (!product.address || product.address.state !== state)) {
                    return false;
                }
                
                // Nearby filter
                if (nearbyOnly && currentLocation) {
                    if (!product.location || !product.location.latitude || !product.location.longitude) {
                        return false;
                    }
                    
                    const distance = calculateDistance(
                        currentLocation.latitude, 
                        currentLocation.longitude,
                        product.location.latitude,
                        product.location.longitude
                    );
                    
                    // Filter products within 50km
                    if (distance > 50) {
                        return false;
                    }
                }
                
                return true;
            });
            
            // Sort products
            sortProducts();
            
            // Update results count
            document.getElementById('results-count').textContent = filteredProducts.length;
            
            // Display products
            displayProducts();
            
            // Update map if visible
            if (nearbyOnly && map) {
                updateMapMarkers();
            }
        }
        
        // Sort products
        function sortProducts() {
            const sortBy = document.getElementById('sort-by').value;
            
            switch (sortBy) {
                case 'price_low':
                    filteredProducts.sort((a, b) => a.price - b.price);
                    break;
                case 'price_high':
                    filteredProducts.sort((a, b) => b.price - a.price);
                    break;
                case 'newest':
                default:
                    // Sort by created_at (newest first)
                    filteredProducts.sort((a, b) => {
                        const aTime = a.created_at && a.created_at._seconds ? a.created_at._seconds : 0;
                        const bTime = b.created_at && b.created_at._seconds ? b.created_at._seconds : 0;
                        return bTime - aTime;
                    });
                    break;
            }
        }
        
        // Display products
        function displayProducts() {
            const container = document.getElementById('products-container');
            const noResults = document.getElementById('no-results');
            
            container.innerHTML = '';
            
            if (filteredProducts.length === 0) {
                noResults.classList.remove('d-none');
                return;
            }
            
            noResults.classList.add('d-none');
            
            filteredProducts.forEach(product => {
                const imageUrl = product.image_urls && product.image_urls.length > 0 
                    ? product.image_urls[0] 
                    : 'https://via.placeholder.com/300x200?text=No+Image';
                
                const productLocation = [
                    product.address?.village,
                    product.address?.district,
                    product.address?.state
                ].filter(Boolean).join(', ');
                
                const card = document.createElement('div');
                card.className = 'col-md-4 mb-4';
                card.innerHTML = `
                    <div class="card product-card h-100">
                        <img src="${imageUrl}" class="card-img-top product-image" alt="${product.name}">
                        <div class="card-body">
                            <h5 class="card-title">${product.name}</h5>
                            <span class="badge bg-light text-dark category-badge">${product.category}</span>
                            <p class="card-text product-price mt-2">â‚¹${product.price} per ${product.unit}</p>
                            <p class="card-text"><small class="text-muted">
                                <i data-feather="map-pin" class="feather-small"></i> ${productLocation}
                            </small></p>
                            
                            <div class="farmer-info mb-3">
                                <div class="farmer-avatar">
                                    <i data-feather="user" class="feather-small"></i>
                                </div>
                                <div>
                                    <small>${product.farmer_name || 'Farmer'}</small>
                                </div>
                            </div>
                            
                            <div class="d-grid">
                                <button class="btn btn-outline-success view-details-btn" data-id="${product.id}">
                                    View Details
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
                
                // Add event listener to the View Details button
                const viewDetailsBtn = card.querySelector('.view-details-btn');
                viewDetailsBtn.addEventListener('click', function() {
                    showProductDetails(product.id);
                });
            });
            
            // Reinitialize feather icons
            feather.replace();
        }
        
        // Show product details
        function showProductDetails(productId) {
            const product = allProducts.find(p => p.id === productId);
            
            if (!product) {
                alert('Product not found');
                return;
            }
            
            // Set modal content
            document.getElementById('modal-product-name').textContent = product.name;
            document.getElementById('modal-product-category').textContent = product.category;
            document.getElementById('modal-product-price').textContent = `â‚¹${product.price} per ${product.unit}`;
            document.getElementById('modal-product-quantity').textContent = `${product.quantity} ${product.unit}`;
            document.getElementById('modal-product-quality').textContent = product.quality_grade || 'Standard';
            document.getElementById('modal-product-description').textContent = product.description;
            
            // Set location
            const productLocation = [
                product.address?.village,
                product.address?.district,
                product.address?.state
            ].filter(Boolean).join(', ');
            document.getElementById('modal-product-location').textContent = productLocation;
            
            // Set farmer details
            document.getElementById('modal-farmer-name').textContent = product.farmer_name || 'Farmer';
            document.getElementById('modal-farmer-location').textContent = productLocation;
            
            // Set main image
            const mainImage = document.getElementById('modal-product-image');
            mainImage.src = product.image_urls && product.image_urls.length > 0 
                ? product.image_urls[0] 
                : 'https://via.placeholder.com/300x200?text=No+Image';
            
            // Set additional images
            const additionalImagesContainer = document.getElementById('modal-additional-images');
            additionalImagesContainer.innerHTML = '';
            
            if (product.image_urls && product.image_urls.length > 1) {
                for (let i = 1; i < Math.min(product.image_urls.length, 4); i++) {
                    const col = document.createElement('div');
                    col.className = 'col-3';
                    col.innerHTML = `
                        <img src="${product.image_urls[i]}" class="img-thumbnail" alt="Additional Image"
                             onclick="document.getElementById('modal-product-image').src='${product.image_urls[i]}'">
                    `;
                    additionalImagesContainer.appendChild(col);
                }
            }
            
            // Setup contact farmer button
            const contactFarmerBtn = document.getElementById('modal-contact-farmer');
            contactFarmerBtn.onclick = () => {
                showContactFarmerModal(product);
            };
            
            // Setup show on map button
            const showOnMapBtn = document.getElementById('modal-show-on-map');
            if (product.location && product.location.latitude && product.location.longitude) {
                showOnMapBtn.classList.remove('d-none');
                showOnMapBtn.onclick = () => {
                    const mapCard = document.getElementById('map-view-card');
                    mapCard.classList.remove('d-none');
                    
                    if (!map) {
                        initMap(product.location.latitude, product.location.longitude);
                    } else {
                        map.setCenter({
                            lat: product.location.latitude,
                            lng: product.location.longitude
                        });
                        map.setZoom(14);
                    }
                    
                    // Close the modal
                    bootstrap.Modal.getInstance(document.getElementById('productDetailModal')).hide();
                    
                    // Scroll to map
                    mapCard.scrollIntoView({ behavior: 'smooth' });
                };
            } else {
                showOnMapBtn.classList.add('d-none');
            }
            
            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('productDetailModal'));
            modal.show();
        }
        
        // Show contact farmer modal
        function showContactFarmerModal(product) {
            // Hide product detail modal
            bootstrap.Modal.getInstance(document.getElementById('productDetailModal')).hide();
            
            // Set contact modal content
            document.getElementById('contact-farmer-name').textContent = product.farmer_name || 'Farmer';
            document.getElementById('contact-product-name').textContent = product.name;
            document.getElementById('contact-unit').textContent = product.unit;
            
            // Setup form submission
            const contactForm = document.getElementById('contact-form');
            contactForm.onsubmit = function(e) {
                e.preventDefault();
                alert('This is a placeholder for contacting the farmer. In the full implementation, this would send a message to the farmer.');
                bootstrap.Modal.getInstance(document.getElementById('contactFarmerModal')).hide();
            };
            
            // Show contact modal
            const modal = new bootstrap.Modal(document.getElementById('contactFarmerModal'));
            modal.show();
        }
        
        // Initialize map
        function initMap(lat, lng) {
            document.getElementById('map').innerHTML = '';
            
            const mapOptions = {
                center: { lat, lng },
                zoom: 10,
                styles: [
                    {
                        featureType: "poi",
                        elementType: "labels",
                        stylers: [{ visibility: "off" }]
                    }
                ]
            };
            
            map = new google.maps.Map(document.getElementById('map'), mapOptions);
            
            // Add marker for user location
            new google.maps.Marker({
                position: { lat, lng },
                map: map,
                title: 'Your Location',
                icon: {
                    url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
                }
            });
            
            // Add product markers
            updateMapMarkers();
        }
        
        // Update map markers
        function updateMapMarkers() {
            if (!map) return;
            
            // Clear existing markers
            markers.forEach(marker => marker.setMap(null));
            markers = [];
            
            // Add new markers
            filteredProducts.forEach(product => {
                if (product.location && product.location.latitude && product.location.longitude) {
                    const marker = new google.maps.Marker({
                        position: { 
                            lat: product.location.latitude, 
                            lng: product.location.longitude 
                        },
                        map: map,
                        title: product.name,
                        icon: {
                            url: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png'
                        }
                    });
                    
                    // Add info window
                    const infoWindow = new google.maps.InfoWindow({
                        content: `
                            <div>
                                <h6>${product.name}</h6>
                                <p>â‚¹${product.price} per ${product.unit}</p>
                                <p>Farmer: ${product.farmer_name || 'Farmer'}</p>
                                <button id="info-view-details-${product.id}" class="btn btn-sm btn-outline-success">
                                    View Details
                                </button>
                            </div>
                        `
                    });
                    
                    marker.addListener('click', () => {
                        infoWindow.open(map, marker);
                        
                        // Add event listener after the info window is opened
                        setTimeout(() => {
                            const viewDetailsBtn = document.getElementById(`info-view-details-${product.id}`);
                            if (viewDetailsBtn) {
                                viewDetailsBtn.addEventListener('click', () => {
                                    showProductDetails(product.id);
                                });
                            }
                        }, 100);
                    });
                    
                    markers.push(marker);
                }
            });
        }
        
        // Populate district dropdown
        function populateDistrictDropdown(products) {
            const districtSelect = document.getElementById('district-filter');
            const districts = new Set();
            
            products.forEach(product => {
                if (product.address && product.address.district) {
                    districts.add(product.address.district);
                }
            });
            
            // Sort districts alphabetically
            const sortedDistricts = Array.from(districts).sort();
            
            sortedDistricts.forEach(district => {
                const option = document.createElement('option');
                option.value = district;
                option.textContent = district;
                districtSelect.appendChild(option);
            });
            
            // Set initial district value if provided in URL
            if (initialDistrict) {
                districtSelect.value = initialDistrict;
            }
        }
        
        // Get user location
        function getUserLocation() {
            return new Promise((resolve, reject) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        position => {
                            resolve({
                                latitude: position.coords.latitude,
                                longitude: position.coords.longitude
                            });
                        },
                        error => {
                            reject(error);
                        }
                    );
                } else {
                    reject(new Error('Geolocation is not supported by this browser.'));
                }
            });
        }
        
        // Calculate distance between two coordinates (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
                
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c;
            
            return distance;
        }
        
        function toRad(degrees) {
            return degrees * Math.PI / 180;
        }
    });
</script>
{% endblock %}
